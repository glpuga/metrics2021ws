<launch>

  <param name="/use_sim_time" value="true" />

  <arg name="dataset" default="FBM1_flight1.bag" />
  <arg name="loop" default="false" />

  <include file="$(find tij_data_view)/launch/metrics_sensors_transformations.launch" />

  <include file="$(find tij_data_view)/launch/rviz.launch">
    <arg name="rviz_config" value="$(find tij_data_view)/config/config.rviz" />
  </include>

  <arg if="$(eval loop==false)" name="loop_args" value="--loop" />

  <node name="rosbag_replayer" pkg="rosbag" type="play" respawn="false" args="--clock $(arg loop_args) $(find tij_data_view)/../../../dataset/$(arg dataset)" output="screen"></node>

  <!-- Decompress the color video feed -->
  <node name="decompress_image" pkg="image_transport" type="republish" args="compressed in:=/camera/color/image_raw raw out:=/camera/color/decompressed" respawn="false" output="screen"></node>

  <!-- Start the nodelet manager node -->
  <node pkg="nodelet" type="nodelet" name="nodelet_manager" args="manager" />

  <!-- Rectify the color image using the camera parameters. Needs the decompressed video feed -->
  <node pkg="nodelet" type="nodelet" name="rectify_color_image" args="load image_proc/rectify nodelet_manager" output="screen">
    <remap from="image_rect" to="/camera/color/rectified" />
    <remap from="image_mono" to="/camera/color/decompressed" />
    <remap from="camera_info" to="/camera/color/camera_info" />
  </node>

  <!-- Register the depth image to the color feed.
       TODO this depends on a transform I made up (color to depth) -->
  <node pkg="nodelet" type="nodelet" name="register_color_image" args="load depth_image_proc/register nodelet_manager" output="screen">
    <remap from="rgb/camera_info" to="/camera/color/camera_info" />
    <remap from="depth/camera_info" to="/camera/depth/camera_info" />
    <remap from="depth/image_rect" to="/camera/depth/image_rect_raw" />
    <remap from="depth_registered/camera_info" to="/camera/depth_registered/camera_info" />
    <remap from="depth_registered/image_rect" to="/camera/depth_registered/image_rect_raw" />
  </node>

  <!-- Create a colorified point cloud from the color feed and the depth map -->
  <node pkg="nodelet" type="nodelet" name="cloudify_depth_image" args="load depth_image_proc/point_cloud_xyzrgb nodelet_manager" output="screen">
    <remap from="depth_registered/points" to="/camera/points" />
    <remap from="rgb/image_rect_color" to="/camera/color/decompressed" />
    <remap from="rgb/camera_info" to="/camera/color/camera_info" />
    <remap from="depth_registered/image_rect" to="/camera/depth_registered/image_rect_raw" />
  </node>

  <!-- OpenVSLAM -->
  <node pkg="openvslam_ros" type="run_slam" name="openvslam"
        args="-v /home/metrics/data/orb_vocab.fbow -c $(find tij_data_view)/config/metrics2021_rgbd.yaml"
        output="screen">
    <remap from="camera/color/image_raw" to="/camera/color/rectified" />
    <remap from="camera/depth/image_raw" to="/camera/depth_registered/image_rect_raw" />
    <param name="odom_frame" value="odom" />
    <param name="map_frame"  value="vicon" />
    <param name="publish_tf" value="true" />
  </node>

</launch>