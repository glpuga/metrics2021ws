<launch>

  <param name="/use_sim_time" value="true" />

  <arg name="dataset"     default="FBM1_flight1" />
  <arg name="loop"        default="false" />
  <arg name="enable_rviz" default="true" />

  <include file="$(find tij_challenger)/launch/metrics_sensors_transformations.launch" />

  <include file="$(find tij_challenger)/launch/replay_dataset_pipeline.launch">
    <arg name="dataset" value="$(arg dataset).bag" />
    <arg name="loop"    value="$(arg loop)" />
  </include>

  <include file="$(find tij_challenger)/launch/rviz.launch"  if="$(eval enable_rviz)">
    <arg name="rviz_config" value="$(find tij_challenger)/config/config.rviz" />
  </include>

  <!-- OpenVSLAM -->
  <!-- <group ns="OpenVSLAM" if="false">
    <arg name="use_hand_tuned_scale" value="false" />

    <arg name="openvslam_config_file" value="metrics2021_rgbd_hand_tuned.yaml" if="$(arg use_hand_tuned_scale)" /> 
    <arg name="openvslam_config_file" value="metrics2021_rgbd.yaml" unless="$(arg use_hand_tuned_scale)" /> 

    <node pkg="openvslam_ros" type="run_slam" name="openvslam"
          args="-v /home/metrics/data/orb_vocab.fbow -c $(find tij_challenger)/config/$(arg openvslam_config_file)"
          output="screen">
      <remap from="camera/color/image_raw" to="/camera/color/decompressed" />
      <remap from="camera/depth/image_raw" to="/camera/depth_registered/image_rect_raw" />
      <remap from="camera_pose" to="/vehicle_odometry" />
      <param name="odom_frame" value="base_link" />
      <param name="map_frame"  value="odom" />
      <param name="publish_tf" value="true" />
    </node>
  
    <node pkg="tij_challenger" type="recorder.py" name="recorder" 
          output="screen" required="true">

      <param name="log_ground_truth"  value="true" />
      <param name="log_ground_truth"  value="true" />

      <param name="stamped_ground_truth_file"
             value="$(find tij_challenger)/performance/$(arg dataset)/stamped_groundtruth.txt" />
      <param name="stamped_traj_file"
             value="$(find tij_challenger)/performance/$(arg dataset)/stamped_traj_estimate.txt" />
    </node>
  </group> -->

  <!-- RTABMap -->
  <group ns="RTABMap">
    <node pkg="rtabmap_ros" type="rgbd_odometry" name="rtabmap_rgbd_odom" output="screen">
      <remap from="rgb/image"       to="/camera/color/decompressed" />
      <remap from="rgb/camera_info" to="/camera/color/camera_info" />
      <remap from="depth/image"     to="/camera/depth_registered/image_rect_raw" />
      <remap from="odom"            to="/vehicle_odometry" />

      <param name="approx_sync"     value="false" />
      <param name="frame_id"        value="base_link" />
      <param name="odom_frame_id"   value="odom" />
      <param name="publish_tf"      value="true" />
    </node>

  
    <node pkg="tij_challenger" type="recorder.py" name="recorder" 
          output="screen" required="true">

      <param name="log_ground_truth"  value="true" />
      <param name="log_ground_truth"  value="true" />

      <param name="stamped_ground_truth_file"
             value="$(find tij_challenger)/performance/$(arg dataset)/stamped_groundtruth.txt" />
      <param name="stamped_traj_file"
             value="$(find tij_challenger)/performance/$(arg dataset)/stamped_traj_estimate.txt" />
    </node>
  </group>


</launch>